<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger - Facebook Clone</title>
    <link rel="stylesheet" th:href="@{/css/messenger.css}">
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
<!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">-->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<style>
    .icon-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        min-width: 18px;
        height: 18px;
        padding: 0 5px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        background-color: #ff3b30;
        box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    .icon-wrapper { position: relative; display: inline-flex; align-items:center; }
    body {
        padding-top: 56px;
        background-color: #F0F2F5;
    }


    .nav-icon-active {
        color: #0866FF;
    }
    .nav-icon-active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background-color: #0866FF;
    }


    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a1a1aa; }
</style>
<body>
<!-- Header -->
<nav class="flex items-center justify-between bg-white px-4 h-14 shadow-md w-full fixed top-0 z-50">
    <!-- Ph·∫ßn b√™n tr√°i -->
    <div class="flex items-center space-x-2">
        <a th:href="@{/facebook/user/home}">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Logo" class="h-10 w-10">
        </a>
        <div class="relative hidden lg:block">
            <i class="fas fa-search absolute top-1/2 left-3 transform -translate-y-1/2 text-gray-500"></i>
            <input type="text" placeholder="T√¨m ki·∫øm tr√™n Facebook"
                   class="bg-gray-100 rounded-full pl-10 pr-4 py-2 h-10 w-60 focus:outline-none">
        </div>
    </div>

    <!-- Ph·∫ßn gi·ªØa -->
    <div class="flex-grow flex items-center justify-center h-full">
        <div class="flex items-center h-full">
            <!-- Icon Ng√¥i nh√† -->
            <a href="#" class="relative flex items-center justify-center w-[112px] h-full nav-icon-active">
                <svg fill="currentColor" viewBox="0 0 24 24" class="w-7 h-7">
                    <path d="M9.464 1.286C10.294.803 11.092.5 12 .5c.908 0 1.707.303 2.537.786.795.462 1.7 1.142 2.815 1.977l2.232 1.675c1.391 1.042 2.359 1.766 2.888 2.826.53 1.059.53 2.268.528 4.006v4.3c0 1.355 0 2.471-.119 3.355-.124.928-.396 1.747-1.052 2.403-.657.657-1.476.928-2.404 1.053-.884.119-2 .119-3.354.119H7.93c-1.354 0-2.471 0-3.355-.119-.928-.125-1.747-.396-2.403-1.053-.656-.656-.928-1.475-1.053-2.403C1 18.541 1 17.425 1 16.07v-4.3c0-1.738-.002-2.947.528-4.006.53-1.06 1.497-1.784 2.888-2.826L6.65 3.263c1.114-.835 2.02-1.515 2.815-1.977zM10.5 13A1.5 1.5 0 0 0 9 14.5V21h6v-6.5a1.5 1.5 0 0 0-1.5-1.5h-3z"></path>
                </svg>
            </a>
            <!-- Icon Video -->
            <a href="#" class="flex items-center justify-center w-[112px] h-[48px] text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                <svg fill="currentColor" viewBox="0 0 24 24" class="w-7 h-7">
                    <path d="M10.996 8.132A1 1 0 0 0 9.5 9v4a1 1 0 0 0 1.496.868l3.5-2a1 1 0 0 0 0-1.736l-3.5-2z"></path>
                    <path d="M14.573 2H9.427c-1.824 0-3.293 0-4.45.155-1.2.162-2.21.507-3.013 1.31C1.162 4.266.817 5.277.655 6.477.5 7.634.5 9.103.5 10.927v.146c0 1.824 0 3.293.155 4.45.162 1.2.507 2.21 1.31 3.012.802.803 1.813 1.148 3.013 1.31C6.134 20 7.603 20 9.427 20h5.146c1.824 0 3.293 0 4.45-.155 1.2-.162 2.21-.507 3.012-1.31.803-.802 1.148-1.813 1.31-3.013.155-1.156.155-2.625.155-4.449v-.146c0-1.824 0-3.293-.155-4.45-.162-1.2-.507-2.21-1.31-3.013-.802-.802-1.813-1.147-3.013-1.309C17.866 2 16.397 2 14.573 2zM3.38 4.879c.369-.37.887-.61 1.865-.741C6.251 4.002 7.586 4 9.5 4h5c1.914 0 3.249.002 4.256.138.978.131 1.496.372 1.865.74.37.37.61.888.742 1.866.135 1.007.137 2.342.137 4.256 0 1.914-.002 3.249-.137 4.256-.132.978-.373 1.496-.742 1.865-.369.37-.887.61-1.865.742-1.007.135-2.342.137-4.256.137h-5c-1.914 0-3.249-.002-4.256-.137-.978-.132-1.496-.373-1.865-.742-.37-.369-.61-.887-.741-1.865C2.502 14.249 2.5 12.914 2.5 11c0-1.914.002-3.249.138-4.256.131-.978.372-1.496.74-1.865zM8 21.5a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2H8z"></path>
                </svg>
            </a>
            <!-- Icon Marketplace -->
            <a href="#" class="flex items-center justify-center w-[112px] h-[48px] text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                <svg fill="currentColor" viewBox="0 0 24 24" class="w-7 h-7">
                    <path d="M1.588 3.227A3.125 3.125 0 0 1 4.58 1h14.84c1.38 0 2.597.905 2.993 2.227l.816 2.719a6.47 6.47 0 0 1 .272 1.854A5.183 5.183 0 0 1 22 11.455v4.615c0 1.355 0 2.471-.119 3.355-.125.928-.396 1.747-1.053 2.403-.656.657-1.475.928-2.403 1.053-.884.12-2 .119-3.354.119H8.929c-1.354 0-2.47 0-3.354-.119-.928-.125-1.747-.396-2.403-1.053-.657-.656-.929-1.475-1.053-2.403-.12-.884-.119-2-.119-3.354V11.5l.001-.045A5.184 5.184 0 0 1 .5 7.8c0-.628.092-1.252.272-1.854l.816-2.719zM10 21h4v-3.5a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5V21zm6-.002c.918-.005 1.608-.025 2.159-.099.706-.095 1.033-.262 1.255-.485.223-.222.39-.55.485-1.255.099-.735.101-1.716.101-3.159v-3.284a5.195 5.195 0 0 1-1.7.284 5.18 5.18 0 0 1-3.15-1.062A5.18 5.18 0 0 1 12 13a5.18 5.18 0 0 1-3.15-1.062A5.18 5.18 0 0 1 5.7 13a5.2 5.2 0 0 1-1.7-.284V16c0 1.442.002 2.424.1 3.159.096.706.263 1.033.486 1.255.222.223.55.39 1.255.485.551.074 1.24.094 2.159.1V17.5a2.5 2.5 0 0 1 2.5-2.5h3a2.5 2.5 0 0 1 2.5 2.5v3.498zM4.581 3c-.497 0-.935.326-1.078.802l-.815 2.72A4.45 4.45 0 0 0 2.5 7.8a3.2 3.2 0 0 0 5.6 2.117 1 1 0 0 1 1.5 0A3.19 3.19 0 0 0 12 11a3.19 3.19 0 0 0 2.4-1.083 1 1 0 0 1 1.5 0A3.2 3.2 0 0 0 21.5 7.8c0-.434-.063-.865-.188-1.28l-.816-2.72A1.125 1.125 0 0 0 19.42 3H4.58z"></path>
                </svg>
            </a>
            <!-- Icon Nh√≥m -->
            <a href="#" class="flex items-center justify-center w-[112px] h-[48px] text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                <svg fill="currentColor" viewBox="0 0 24 24" class="w-7 h-7">
                    <path d="M.5 12c0 6.351 5.149 11.5 11.5 11.5S23.5 18.351 23.5 12 18.351.5 12 .5.5 5.649.5 12zm2 0c0-.682.072-1.348.209-1.99a2 2 0 0 1 0 3.98A9.539 9.539 0 0 1 2.5 12zm.84-3.912A9.502 9.502 0 0 1 12 2.5a9.502 9.502 0 0 1 8.66 5.588 4.001 4.001 0 0 0 0 7.824 9.514 9.514 0 0 1-1.755 2.613A5.002 5.002 0 0 0 14 14.5h-4a5.002 5.002 0 0 0-4.905 4.025 9.515 9.515 0 0 1-1.755-2.613 4.001 4.001 0 0 0 0-7.824zM12 5a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm-2 4a2 2 0 1 0 4 0 2 2 0 0 0-4 0zm11.291 1.01a9.538 9.538 0 0 1 0 3.98 2 2 0 0 1 0-3.98zM16.99 20.087A9.455 9.455 0 0 1 12 21.5c-1.83 0-3.54-.517-4.99-1.414a1.004 1.004 0 0 1-.01-.148V19.5a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v.438a1 1 0 0 1-.01.148z"></path>
                </svg>
            </a>
            <!-- Icon Tr√≤ ch∆°i -->
            <a href="#" class="flex items-center justify-center w-[112px] h-[48px] text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                <svg fill="currentColor" viewBox="0 0 24 24" class="w-7 h-7">
                    <path d="M8 8a1 1 0 0 1 1 1v2h2a1 1 0 1 1 0 2H9v2a1 1 0 1 1-2 0v-2H5a1 1 0 1 1 0-2h2V9a1 1 0 0 1 1-1zm8 2a1.5 1.5 0 1 0 3 0 1.5 1.5 0 0 0-3 0zm-2 4a1.5 1.5 0 1 0 3 0 1.5 1.5 0 0 0-3 0z"></path>
                    <path d="M.5 11a7 7 0 0 1 7-7h9a7 7 0 0 1 7 7v2a7 7 0 0 1-7 7h-9a7 7 0 0 1-7-7v-2zm7-5a5 5 0 0 0-5 5v2a5 5 0 0 0 5 5h9a5 5 0 0 0 5-5v-2a5 5 0 0 0-5-5h-9z"></path>
                </svg>
            </a>
        </div>
    </div>

    <!-- Ph·∫ßn b√™n ph·∫£i -->
    <div class="flex items-center space-x-2">
        <!-- Icon Menu  -->
        <a href="#" class="flex items-center justify-center w-10 h-10 bg-gray-200 rounded-full text-gray-800 hover:bg-gray-300 transition-colors">
            <svg fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
                <path d="M18.5 1A1.5 1.5 0 0 0 17 2.5v3A1.5 1.5 0 0 0 18.5 7h3A1.5 1.5 0 0 0 23 5.5v-3A1.5 1.5 0 0 0 21.5 1h-3zm0 8a1.5 1.5 0 0 0-1.5 1.5v3a1.5 1.5 0 0 0 1.5 1.5h3a1.5 1.5 0 0 0 1.5-1.5v-3A1.5 1.5 0 0 0 21.5 9h-3zm-16 8A1.5 1.5 0 0 0 1 18.5v3A1.5 1.5 0 0 0 2.5 23h3A1.5 1.5 0 0 0 7 21.5v-3A1.5 1.5 0 0 0 5.5 17h-3zm8 0A1.5 1.5 0 0 0 9 18.5v3a1.5 1.5 0 0 0 1.5 1.5h3a1.5 1.5 0 0 0 1.5-1.5v-3a1.5 1.5 0 0 0-1.5-1.5h-3zm8 0a1.5 1.5 0 0 0-1.5 1.5v3a1.5 1.5 0 0 0 1.5 1.5h3a1.5 1.5 0 0 0 1.5-1.5v-3a1.5 1.5 0 0 0-1.5-1.5h-3zm-16-8A1.5 1.5 0 0 0 1 10.5v3A1.5 1.5 0 0 0 2.5 15h3A1.5 1.5 0 0 0 7 13.5v-3A1.5 1.5 0 0 0 5.5 9h-3zm0-8A1.5 1.5 0 0 0 1 2.5v3A1.5 1.5 0 0 0 2.5 7h3A1.5 1.5 0 0 0 7 5.5v-3A1.5 1.5 0 0 0 5.5 1h-3zm8 0A1.5 1.5 0 0 0 9 2.5v3A1.5 1.5 0 0 0 10.5 7h3A1.5 1.5 0 0 0 15 5.5v-3A1.5 1.5 0 0 0 13.5 1h-3zm0 8A1.5 1.5 0 0 0 9 10.5v3a1.5 1.5 0 0 0 1.5 1.5h3a1.5 1.5 0 0 0 1.5-1.5v-3A1.5 1.5 0 0 0 13.5 9h-3z"></path>
            </svg>
        </a>

        <!-- Icon Messenger  -->
        <a th:href="@{/facebook/user/messages}" class="relative flex items-center justify-center w-10 h-10 bg-gray-200 rounded-full text-gray-800 hover:bg-gray-300 transition-colors">
            <svg fill="currentColor" viewBox="0 0 12 12" class="w-5 h-5">
                <path d="m106.868 921.248-1.892 2.925a.32.32 0 0 1-.443.094l-1.753-1.134a.2.2 0 0 0-.222.003l-1.976 1.363c-.288.199-.64-.143-.45-.437l1.892-2.925a.32.32 0 0 1 .443-.095l1.753 1.134a.2.2 0 0 0 .222-.003l1.976-1.363c.288-.198.64.144.45.438m-3.368-4.251c-3.323 0-5.83 2.432-5.83 5.658 0 1.642.652 3.128 1.834 4.186a.331.331 0 0 1 .111.234l.03 1.01a.583.583 0 0 0 .82.519l1.13-.5a.32.32 0 0 1 .22-.015c.541.148 1.108.223 1.685.223 3.323 0 5.83-2.432 5.83-5.657 0-3.226-2.507-5.658-5.83-5.658" transform="translate(-97.5 -916.655)"></path>
            </svg>
            <span class="icon-badge" th:if="${unreadMessages != null and unreadMessages > 0}" th:text="${unreadMessages}"></span>
        </a>

        <!-- Icon Chu√¥ng th√¥ng b√°o  -->
        <a href="#" class="relative flex items-center justify-center w-10 h-10 bg-gray-200 rounded-full text-gray-800 hover:bg-gray-300 transition-colors">
            <svg fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
                <path d="M3 9.5a9 9 0 1 1 18 0v2.927c0 1.69.475 3.345 1.37 4.778a1.5 1.5 0 0 1-1.272 2.295h-4.625a4.5 4.5 0 0 1-8.946 0H2.902a1.5 1.5 0 0 1-1.272-2.295A9.01 9.01 0 0 0 3 12.43V9.5zm6.55 10a2.5 2.5 0 0 0 4.9 0h-4.9z"></path>
            </svg>
            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-semibold rounded-full w-5 h-5 flex items-center justify-center">4</span>
        </a>

        <!-- Profile v√† Menu dropdown  -->
        <div class="relative">
            <button id="profile-menu-button" class="focus:outline-none relative">
                <!-- ·∫¢nh ƒë·∫°i di·ªán -->
                <img th:src="@{/images/default-avatar.svg}" src="https://placehold.co/40x40/E4E6EB/7F7F7F?text=User" alt="Profile" class="h-10 w-10 rounded-full object-cover">

                <!-- V√≤ng tr√≤n ch·ª©a m≈©i t√™n dropdown -->
                <div class="absolute -bottom-0.5 -right-0.5">
                    <div class="bg-gray-200 rounded-full w-5 h-5 flex items-center justify-center border-2 border-white">
                        <svg viewBox="0 0 16 16" width="12" height="12" fill="currentColor" class="text-gray-800">
                            <g fill-rule="evenodd" transform="translate(-448 -544)">
                                <path fill-rule="nonzero" d="M452.707 549.293a1 1 0 0 0-1.414 1.414l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0-1.414-1.414L456 552.586l-3.293-3.293z"></path>
                            </g>
                        </svg>
                    </div>
                </div>
            </button>

            <!-- Menu th·∫£ xu·ªëng  -->
            <div id="profile-dropdown-menu" class="hidden absolute right-0 mt-2 w-96 bg-white border border-gray-200 rounded-lg shadow-xl z-50 overflow-hidden">
                <div class="p-2 custom-scrollbar" style="max-height: 90vh; overflow-y: auto;">
                    <div class="p-2 rounded-lg shadow-md mb-2 bg-white">
                        <a href="/facebook/profile" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100">
                            <img th:src="@{/images/default-avatar.svg}" src="https://placehold.co/60x60/E4E6EB/7F7F7F?text=User" alt="Profile" class="h-14 w-14 rounded-full object-cover">
                            <div>
<!--                                <p class="font-semibold text-gray-800" th:text="${user.firstName} + ' ' + ${user.lastName}">User Name</p>-->
                                <p class="font-semibold text-gray-800" th:text="${currentUsername}">User Name</p>
                            </div>
                        </a>
                        <hr class="my-2">
                        <button class="w-full text-center py-2 text-blue-600 font-semibold bg-blue-50 rounded-lg hover:bg-blue-100">Xem t·∫•t c·∫£ trang c√° nh√¢n</button>
                    </div>
                    <ul class="text-gray-700">
                        <li>
                            <a href="/settings" class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-100">
                                <div class="flex items-center space-x-3"><i class="fas fa-cog text-xl bg-gray-200 p-2 rounded-full w-9 h-9 flex items-center justify-center"></i><span class="font-semibold">C√†i ƒë·∫∑t & quy·ªÅn ri√™ng t∆∞</span></div><i class="fas fa-chevron-right text-gray-500"></i>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-100">
                                <div class="flex items-center space-x-3"><i class="fas fa-question-circle text-xl bg-gray-200 p-2 rounded-full w-9 h-9 flex items-center justify-center"></i><span class="font-semibold">Tr·ª£ gi√∫p & h·ªó tr·ª£</span></div><i class="fas fa-chevron-right text-gray-500"></i>
                            </a>
                        </li>
                        <li>
                            <form th:action="@{/logout}" method="post" class="block w-full">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button type="submit" class="w-full flex items-center p-2 rounded-lg hover:bg-gray-100 text-left"><div class="flex items-center space-x-3"><i class="fas fa-sign-out-alt text-xl bg-gray-200 p-2 rounded-full w-9 h-9 flex items-center justify-center"></i><span class="font-semibold">ƒêƒÉng xu·∫•t</span></div></button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Main Container -->
<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">ƒêo·∫°n chat</h2>
            <input type="text" class="search-conversations" placeholder="T√¨m ki·∫øm tr√™n Messenger">

            <div class="sidebar-tabs">
                <div class="sidebar-tab active">T·∫•t c·∫£</div>
                <div class="sidebar-tab">Ch∆∞a ƒë·ªçc</div>
                <div class="sidebar-tab">Nh√≥m</div>
            </div>
        </div>

        <div class="conversations-list">
            <div th:if="${conversations != null}" th:each="conv : ${conversations}"
                 th:class="'conversation-item ' + (${conv.conversationId} == ${conversationId} ? 'active' : '')">
                <a th:href="@{'/facebook/messenger/' + ${conv.conversationId}}" style="display:flex; text-decoration:none; color:inherit;">
                    <div class="conversation-avatar">
                        <span th:text="${conv.conversationName != null and conv.conversationName.length() >= 2 ? #strings.substring(conv.conversationName,0,2) : conv.conversationName}"></span>
                        <div class="online-dot"></div>
                    </div>
                    <div class="conversation-content">
                        <div class="conversation-name" th:text="${conv.conversationName}"></div>
                        <div class="conversation-preview">
                            <span th:text="${conv.lastMessage != null ? conv.lastMessage : 'Ch∆∞a c√≥ tin nh·∫Øn'}"></span>
                            <span class="conversation-time"
                                  th:text="${conv.lastMessageTime != null ? '¬∑ ' + #temporals.format(conv.lastMessageTime, 'HH:mm dd/MM') : ''}"></span>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Chat Area -->
    <div th:if="${conversationId != null}" class="chat-area">
        <div class="chat-header">
            <div class="chat-header-left"
                 th:with="currentConv=${conversations.?[conversationId == conversationId][0]}">
                <div class="chat-avatar">
                    <span th:text="${#strings.substring(currentConv.conversationName, 0, 2)}"></span>
                    <div class="online-dot"></div>
                </div>
                <div class="chat-info">
                    <h3 th:text="${currentConv.conversationName}"></h3>
                    <div class="chat-status">ƒêang ho·∫°t ƒë·ªông</div>
                </div>
            </div>

            <div class="chat-actions">
                <div class="chat-action-btn">üìû</div>
                <div class="chat-action-btn">üìπ</div>
                <div class="chat-action-btn">‚ÑπÔ∏è</div>
            </div>
        </div>

        <div class="messages-container">
            <div th:if="${messages != null}" th:each="msg : ${messages}"
                 th:class="'message ' + (${msg.sender.id} == ${currentUserId} ? 'sent' : 'received')">
                <div class="message-bubble">
                    <div th:if="${msg.sender.id != currentUserId}" class="message-sender"
                         th:text="${msg.sender.firstName + ' ' + msg.sender.lastName}"></div>
                    <div th:text="${msg.content}"></div>
                </div>
            </div>
        </div>

        <div class="message-input-area">
            <form th:action="@{/facebook/messenger/send}" method="post" class="message-input-container">
                <div class="input-actions" style="margin-right: 8px;">
                    <div class="input-btn">üé§</div>
                </div>
                <input type="text" name="content" class="message-input" placeholder="Aa" required>
                <div class="input-actions">
                    <div class="input-btn">üìé</div>
                    <div class="input-btn">üòä</div>
                    <div class="input-btn">üì∑</div>
                    <button type="submit" class="input-btn send-btn">üëç</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Th√¥ng b√°o n·∫øu ch∆∞a ch·ªçn conversation -->
    <div th:if="${conversationId == null}" class="chat-area">
        <p style="padding:20px; color:#555;">Vui l√≤ng ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin.</p>
    </div>
</div>


<!-- Scripts -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const messageInput = document.querySelector('.message-input');
        const sendBtn = document.querySelector('.send-btn');
        const messagesContainer = document.querySelector('.messages-container');

        // D·ªØ li·ªáu Thymeleaf t·ª´ backend
        const conversationId = /*[[${conversationId}]]*/ "0";
        const currentUserId = /*[[${currentUserId}]]*/ "0";
        const currentUsername = /*[[${currentUsername}]]*/ "B·∫°n";

        // STOMP client
        let stompClient = null;

        function connect() {
            stompClient = new StompJs.Client({
                connectHeaders: {},
                brokerURL: "ws://localhost:8080/ws",
                debug: function(str) { console.log(str); },
                reconnectDelay: 5000,
                heartbeatIncoming: 4000,
                heartbeatOutgoing: 4000,
                onConnect: (frame) => {
                    console.log("‚úÖ Connected to broker, session:", frame.headers['session']);
                    stompClient.subscribe('/topic/conversation/' + conversationId, (message) => {
                        const msg = JSON.parse(message.body);
                        appendMessage(msg);
                    });
                },
                onStompError: (frame) => {
                    console.error('Broker reported error: ' + frame.headers['message']);
                    console.error('Additional details: ' + frame.body);
                }
            });
            stompClient.activate();

        }

        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !stompClient) return;

            // Ch·ªâ g·ª≠i content
            stompClient.publish({
                destination: "/app/chat/" + conversationId,
                body: JSON.stringify({ content: content })
            });

            messageInput.value = '';
        }

        function appendMessage(msg) {
            // √©p ki·ªÉu ƒë·ªÉ so s√°nh ch√≠nh x√°c
            const isMine = parseInt(msg.senderId) === parseInt(currentUserId);

            const messageEl = document.createElement('div');
            messageEl.className = 'message ' + (isMine ? 'sent' : 'received');
            messageEl.innerHTML = `
        <div class="message-bubble">
            ${!isMine ? `<div class="message-sender">${msg.senderFullName}</div>` : ''}
            <div>${msg.content}</div>
            <small class="message-time">${msg.timestamp}</small>
        </div>
    `;
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }



        // Thay ƒë·ªïi n√∫t g·ª≠i khi g√µ
        messageInput.addEventListener('input', function() {
            if (this.value.trim()) {
                sendBtn.textContent = '‚û§';
            } else {
                sendBtn.textContent = 'üëç';
            }
            sendBtn.style.backgroundColor = '#1877f2';
        });

        // G·ª≠i khi b·∫•m n√∫t
        sendBtn.addEventListener('click', sendMessage);

        // G·ª≠i khi nh·∫•n Enter
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Sidebar tabs
        const sidebarTabs = document.querySelectorAll('.sidebar-tab');
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                sidebarTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Nav icons
        const navIcons = document.querySelectorAll('.nav-icon');
        navIcons.forEach(icon => {
            icon.addEventListener('click', function() {
                navIcons.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Mobile sidebar toggle
        const mobileToggle = document.createElement('div');
        mobileToggle.style.display = 'none';
        mobileToggle.innerHTML = '‚ò∞';
        mobileToggle.className = 'header-btn';
        mobileToggle.style.fontSize = '18px';

        if (window.innerWidth <= 768) {
            document.querySelector('.header-left').prepend(mobileToggle);
            mobileToggle.style.display = 'flex';
            mobileToggle.addEventListener('click', function() {
                document.querySelector('.sidebar').classList.toggle('open');
            });
        }

        // K·∫øt n·ªëi WebSocket khi load xong
        connect();
    });
</script>
<script>

    const profileMenuButton = document.getElementById('profile-menu-button');
    const profileDropdownMenu = document.getElementById('profile-dropdown-menu');

    if (profileMenuButton && profileDropdownMenu) {

        profileMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdownMenu.classList.toggle('hidden');
        });
    }


    window.addEventListener('click', (e) => {
        if (profileDropdownMenu &&
            !profileDropdownMenu.classList.contains('hidden') &&
            !profileDropdownMenu.contains(e.target) &&
            !profileMenuButton.contains(e.target)) {
            profileDropdownMenu.classList.add('hidden');
        }
    });
</script>
</body>
</html>